# dati: https://www.epicentro.iss.it/coronavirus/bollettino/Bollettino-sorveglianza-integrata-COVID-19_17-novembre-2021.pdf
# https://www.thelancet.com/journals/lancet/article/PIIS0140673610605417/fulltext
# efficacia vaccinale (1-RR)*100

fonte<-"https://www.epicentro.iss.it/coronavirus/bollettino/Bollettino-sorveglianza-integrata-COVID-19_17-novembre-2021.pdf"
pop_no_vax<-7862567
pop_vax<-38968164 # VACCINATI CON CICLO COMPLETO ENTRO 6 MES

tot_covid<-50564+ 3980 + 60407 + 11215 + 537
covid_no_vax<-50564
covid_vax<-60407

ospedale_no_vax<-3220
ospedale_vax<-2075

terapia_intensiva_no_vax<-424
terapia_intensiva_vax<-177

decessi_no_vax<-384
decessi_vax<-309


# diagnosticamento covid
p_covid_no_vax<-covid_no_vax/pop_no_vax
p_covid_vax<-covid_vax/pop_vax
# odd_ratio_covid<-p_covid_no_vax/p_covid_vax

# ospedalizzazioni
p_ospedale_no_vax<-ospedale_no_vax/pop_no_vax
p_ospedale_vax<-ospedale_vax/pop_vax
# odd_ratio_ospedale<-p_ospedale_no_vax/p_ospedale_vax

# terapie intensive
p_terapia_intensiva_no_vax<-terapia_intensiva_no_vax/pop_no_vax
p_terapia_intensiva_vax<-terapia_intensiva_vax/pop_vax
# odd_ratio_terapia_intensiva<-p_terapia_intensiva_no_vax/p_terapia_intensiva_vax

# decessi
p_decessi_no_vax<-decessi_no_vax/pop_no_vax
p_decessi_vax<-decessi_vax/pop_vax
# odd_ratio_decessi<-p_decessi_no_vax/p_decessi_vax

res<-rbind(c(p_covid_no_vax, p_covid_vax),
c(p_ospedale_no_vax, p_ospedale_vax),
c(p_terapia_intensiva_no_vax, p_terapia_intensiva_vax),
c(p_decessi_no_vax, p_decessi_vax)
)

risk_ratios<-res[,1]/res[,2]
inv_rr<-res[,2]/res[,1] # risk ratio in direzione opposta
efficacia_vaccinale<- (1-inv_rr)*100 # efficacia vaccinale, non capisco l'interpretazione...
res<-cbind(res, risk_ratios)



colnames(res)<-c("perc_no_vax", "perc_vax", "odds_ratio")
rownames(res)<-c("diagnosi_covid", "ospedalizzazione", "terapia_intensiva", "morte")
round(res, 6)


library(eulerr)
library(cowplot)
library(latex2exp)
library(ggplot2)

# ospedalizzati
plot_base <- euler(c("vax" = 10, "no_vax" = 4, "covid"=2,
                 "vax&covid" = 2 , "no_vax&covid" = 1 ),
               shape = "ellipse",
               # control = list(extraopt = FALSE)
               )

p_covid_ospedalizzati<-plot(plot_base,
     main="Ospedalizzati \n 08/10/2021 - 7/11/2021",
     labels = c(
         "Vaccinati (<6 mesi)",
         "Non vaccinati",
         "Ospedalizzati"
         ),
     fill = c("red", "green", "orange"),
     quantities = list(type = c("percent"))
     )


quantities_ospedalizzati<-c(1-p_ospedale_vax, 1-p_ospedale_no_vax, 0, p_ospedale_vax, p_ospedale_no_vax )
quantities_ospedalizzati<-quantities_ospedalizzati*100
quantities_ospedalizzati<-round(quantities_ospedalizzati, 3)
quantities_ospedalizzati<-sapply(quantities_ospedalizzati, paste, "%")
quantities_ospedalizzati[3]<-""

p_covid_ospedalizzati$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.1$children$tag.quantity.1$label<-quantities_ospedalizzati[1]
p_covid_ospedalizzati$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.2$children$tag.quantity.2$label<-quantities_ospedalizzati[2]
p_covid_ospedalizzati$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.3$children$tag.quantity.3$label<-quantities_ospedalizzati[3]
p_covid_ospedalizzati$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.4$children$tag.quantity.4$label<-quantities_ospedalizzati[4]
p_covid_ospedalizzati$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.5$children$tag.quantity.5$label<-quantities_ospedalizzati[5]
# p_covid_ospedalizzati

# formula p_covid_ospedalizzati
espressione<-TeX(r'(Rischio relativo ospedalizzazione =\frac{\frac{ Non vaccinati ospedalizzati }{ Popolazione non vaccinata}}{ \frac{ Vaccinati ospedalizzati }{ Popolazione vaccinata}} = \frac{\frac{3.220}{7.862.567}}{\frac{2.075}{38.968.164}} ~ \frac{  0,00041}{0,00005} =  8,2  )')
spiega_ospedali<-ggplot() +
    theme_void() +
    xlab(NULL)+annotate("text",  x=10, y=40, label=espressione,  parse=TRUE, size = 5.5)



# terapie intensive
p_covid_terapie_intensive<-plot(plot_base,
                            main="Terapie Intensive \n 08/10/2021 - 7/11/2021",
                            labels = c(
                                "Vaccinati (<6 mesi)",
                                "Non vaccinati",
                                "Terapie Intensive"
                            ),
                            fill = c("red", "green", "orange"),
                            quantities = list(type = c("percent"))
)

quantities_terapia_intensiva<-c(1-p_terapia_intensiva_vax, 1-p_terapia_intensiva_no_vax, 0, p_terapia_intensiva_vax, p_terapia_intensiva_no_vax )
quantities_terapia_intensiva<-quantities_terapia_intensiva*100
quantities_terapia_intensiva<-round(quantities_terapia_intensiva, 4)
quantities_terapia_intensiva<-format(quantities_terapia_intensiva, digits=4, nsmall=4)
quantities_terapia_intensiva<-sapply(quantities_terapia_intensiva, paste, "%")
quantities_terapia_intensiva[3]<-""

p_covid_terapie_intensive$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.1$children$tag.quantity.1$label<-quantities_terapia_intensiva[1]
p_covid_terapie_intensive$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.2$children$tag.quantity.2$label<-quantities_terapia_intensiva[2]
p_covid_terapie_intensive$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.3$children$tag.quantity.3$label<-quantities_terapia_intensiva[3]
p_covid_terapie_intensive$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.4$children$tag.quantity.4$label<-quantities_terapia_intensiva[4]
p_covid_terapie_intensive$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.5$children$tag.quantity.5$label<-quantities_terapia_intensiva[5]

# formula terapia intensiva
espressione<-TeX(r'(Rischio relativo terapie intensive =\frac{\frac{ Non vaccinati in terapia intensiva }{ Popolazione non vaccinata}}{ \frac{ Vaccinati in terapia intensiva }{ Popolazione vaccinata}} = \frac{\frac{424}{7.862.567}}{\frac{177}{38.968.164}} ~ \frac{  0,000054}{0,000005} = 10,8  )')
spiega_terapie_intensive<-ggplot() +
    theme_void() +
    xlab(NULL)+annotate("text",  x=10, y=40, label=espressione,  parse=TRUE, size = 5.5)

# morti
p_covid_morti<-plot(plot_base,
                                main="Morti \n 24/09/2021 - 24/10/2021",
                                labels = c(
                                    "Vaccinati (<6 mesi)",
                                    "Non vaccinati",
                                    "Morti"
                                ),
                                fill = c("red", "green", "orange"),
                                quantities = list(type = c("percent"))
)

quantities_morti<-c(1-p_decessi_vax, 1-p_decessi_no_vax, 0, p_decessi_vax, p_decessi_no_vax )
quantities_morti<-quantities_morti*100
quantities_morti<-round(quantities_morti, 4)
quantities_morti<-format(quantities_morti, digits=5, nsmall=4)
quantities_morti<-sapply(quantities_morti, paste, "%")
quantities_morti[3]<-""

p_covid_morti$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.1$children$tag.quantity.1$label<-quantities_morti[1]
p_covid_morti$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.2$children$tag.quantity.2$label<-quantities_morti[2]
p_covid_morti$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.3$children$tag.quantity.3$label<-quantities_morti[3]
p_covid_morti$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.4$children$tag.quantity.4$label<-quantities_morti[4]
p_covid_morti$children$canvas.grob$children$diagram.grob.1$children$tags$children$tag.number.5$children$tag.quantity.5$label<-quantities_morti[5]

# formula morti
espressione<-TeX(r'(Rischio relativo mortalita' =\frac{\frac{ Non vaccinati deceduti }{ Popolazione non vaccinata}}{ \frac{ Vaccinati deceduti }{ Popolazione vaccinata}} = \frac{\frac{384 }{7.862.567}}{\frac{309 }{38.968.164}} ~ \frac{  0,000049}{0,000008} = 6,125  )')
spiega_morti<-ggplot() +
    theme_void() +
    xlab(NULL)+annotate("text",  x=10, y=40, label=espressione,  parse=TRUE, size = 5.5)

# combine plots
plotto_all<-plot_grid(p_covid_ospedalizzati, spiega_ospedali,
          p_covid_terapie_intensive, spiega_terapie_intensive,
          p_covid_morti, spiega_morti,
          ncol = 2,  scale = 0.9)

ploto_ospedalizzati<-plot_grid(p_covid_ospedalizzati, spiega_ospedali, ncol=1,  scale = 0.9)
ploto_terapie_intensive<-plot_grid(p_covid_terapie_intensive, spiega_terapie_intensive, ncol=1,  scale = 0.9)
ploto_morti<-plot_grid(p_covid_morti, spiega_morti, ncol=1,  scale = 0.9)

save_plot("plotto_all.jpg", plotto_all, base_height = 3.71*3.5)
save_plot("plotto_ospedalizzati.jpg", ploto_ospedalizzati, base_height = 3.71*3.5)
save_plot("plotto_terapie_intensive.jpg", ploto_terapie_intensive, base_height = 3.71*3.5)
save_plot("plotto_morti.jpg", ploto_morti, base_height = 3.71*3.5)



rm(list=ls())
# barplot risk ratios
pop_no_vax<-c(3423613 , 2932766, 1278622, 227566)
pop_vax<-c(12150128 , 13554449, 1127387, 1989709)

# ospedali
ospedali_no_vax<-c(476 , 1055, 1181, 508 )
ospedali_vax<-c(94 , 260 , 1016, 705 )

p_ospedali_no_vax<-ospedali_no_vax/pop_no_vax
p_ospedali_vax<-ospedali_vax/pop_vax
rr_ospedali<- p_ospedali_no_vax/p_ospedali_vax

# terapie intensive
terapie_no_vax<-c(24 , 126 , 244 , 30 )
terapie_vax<-c(0, 18 , 117 , 42 )
p_terapia_intensiva_no_vax<-terapie_no_vax/pop_no_vax
p_terapia_intensiva_vax<-terapie_vax/pop_vax
rr_terapia_intensiva<-p_terapia_intensiva_no_vax/p_terapia_intensiva_vax



# Plot
library(ggplot2)
df<-data.frame(rr_ospedali=rr_ospedali, group=c("1", "2","3","4"))
p <- ggplot(df, aes(x = rr_ospedali ,y=group)) +
    geom_vline(aes(xintercept = 1), size = .25, linetype = "dashed")  +
    geom_point()+ 
    # coord_trans(x = "log10") +
    coord_flip()
p
